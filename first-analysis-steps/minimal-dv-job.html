<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running a minimal DaVinci job locally &mdash; LHCb Starterkit Lessons  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/panels.css" />
      <link rel="stylesheet" type="text/css" href="../_static/starterkit.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/panels.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Fun with LoKi Functors" href="loki-functors.html" />
    <link rel="prev" title="Interactively exploring a DST" href="interactive-dst.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            LHCb Starterkit Lessons
              <img src="../_static/starterkit.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="README.html">First Analysis Steps</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="prerequisites.html">Pre-workshop checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction-to-course.html">Goals of the course</a></li>
<li class="toctree-l2"><a class="reference internal" href="physics-at-lhcb.html">Physics at LHCb</a><ul>
<li class="toctree-l3"><a class="reference internal" href="physics-at-lhcb.html#the-reconstruction">The reconstruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="physics-at-lhcb.html#building-decay-candidates">Building decay candidates</a></li>
<li class="toctree-l3"><a class="reference internal" href="physics-at-lhcb.html#building-more-complex-decays">Building more complex decays</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dataflow.html">The LHCb data flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="run-2-data-flow.html">Changes to the data flow in Run 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysisflow.html">The analysis flow and analysis preservation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="analysisflow.html#getting-data-files">Getting data files</a></li>
<li class="toctree-l3"><a class="reference internal" href="analysisflow.html#useful-high-energy-physics-analysis-tools">Useful high energy physics analysis tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="analysisflow.html#analysis-preservation">Analysis Preservation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="davinci.html">An introduction to LHCb Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="bookkeeping.html">Finding data in the Bookkeeping</a></li>
<li class="toctree-l2"><a class="reference internal" href="files-from-grid.html">Downloading a file from the grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactive-dst.html">Interactively exploring a DST</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running a minimal DaVinci job locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="loki-functors.html">Fun with LoKi Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="add-tupletools.html">TupleTools and branches</a></li>
<li class="toctree-l2"><a class="reference internal" href="decay-tree-fitter.html">How do I use DecayTreeFitter?</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysis-productions.html">Analysis Productions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="analysis-productions.html#monitoring-productions">Monitoring productions</a></li>
<li class="toctree-l3"><a class="reference internal" href="analysis-productions.html#creating-your-own-production">Creating your own production</a><ul>
<li class="toctree-l4"><a class="reference internal" href="analysis-productions.html#testing-your-production-locally">Testing your production locally</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis-productions.html#creating-a-merge-request">Creating a merge request</a></li>
<li class="toctree-l4"><a class="reference internal" href="analysis-productions.html#analysis-productions-data">Analysis Productions Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="davinci-grid.html">Running DaVinci on the grid</a></li>
<li class="toctree-l2"><a class="reference internal" href="split-jobs.html">Splitting a job into subjobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="ganga-data.html">More Ganga</a></li>
<li class="toctree-l2"><a class="reference internal" href="eos-storage.html">Storing large files on EOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="lhcb-dev.html">Developing LHCb Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataflow-run3.html">LHCb data flow in Run 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dataflow-run3.html#lhcb-upgrade">LHCb upgrade</a></li>
<li class="toctree-l3"><a class="reference internal" href="dataflow-run3.html#upgrade-of-the-lhcb-trigger-system">Upgrade of the LHCb trigger system</a><ul>
<li class="toctree-l4"><a class="reference internal" href="dataflow-run3.html#the-hlt-architecture">The HLT architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="dataflow-run3.html#selective-persistency">Selective persistency</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dataflow-run3.html#offline-data-processing">Offline data processing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="dataflow-run3.html#changes-to-davinci">Changes to DaVinci</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="asking-questions.html">Asking good questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="ecgd.html">Early career, gender and diversity</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing-lesson.html">Contribute to this lesson</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../second-analysis-steps/README.html">Second Analysis Steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/lb-git.html">Using git to develop LHCb software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/building-decays.html">Building your own decay</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/building-decays-part0.html">The Selection Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/building-decays-part1.html">A Historical Approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/building-decays-part2.html">Modern Selection Framework</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/fixing-errors.html">What to do when something fails</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/rerun-stripping.html">Run a different stripping line on simulated data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/switch-mass-hypo.html">Replace a mass hypothesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/filter-in-trees.html">Reuse particles from a decay tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/simulation.html">The simulation framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-intro.html">What is Gauss?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-intro.html#choosing-your-gauss-version">Choosing your Gauss Version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-running-gauss.html">Which option files to use and how to run Gauss</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-running-gauss.html#running-gauss-and-create-a-generator-only-sample">Running Gauss and create a generator-only sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-running-gauss.html#make-an-ntuple">Make an nTuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-dkfiles.html">Controlling the decay: DecFiles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html">Modifying the decay</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#adding-a-decay-channel">Adding a decay channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#generator-level-cuts">Generator level cuts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#removing-the-generator-cuts">Removing the generator cuts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-gencuts.html#modifying-the-cut-tool">Modifying the cut tool</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html">Advanced: Modifying the decay</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#multi-body-decays">3+ multi-body decays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#cocktail-decays">Cocktail decays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#final-state-radiation">Final state radiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#changing-particle-masses-lifetimes-widths">Changing particle masses / lifetimes/ widths</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-advanced-dkfiles.html#finding-constants-used-in-an-existing-mc-sample-masses-lifetimes-etc">Finding Constants Used in an Existing MC Sample (Masses/Lifetimes/etc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/simulation-fastsim.html">Why fast simulation is crucial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-fastsim.html#speeding-up-the-detector-simulation">Speeding up the detector simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../second-analysis-steps/simulation-fastsim.html#speeding-up-the-generation">Speeding up the generation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html">HLT intro</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#add-trigger-information-to-your-ntuple">Add trigger information to your ntuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#exploring-a-tck-list-of-trigger-lines">Exploring a TCK: List of trigger lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#add-trigger-information-to-your-ntuple-continued">Add trigger information to your ntuple, continued</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#add-tistos-information-to-your-ntuple">Add TISTOS information to your ntuple</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/hlt-intro.html#exploring-a-tck-properties-of-trigger-lines">Exploring a TCK: Properties of trigger lines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/tistos-diy.html">TisTos DIY</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/ganga-scripting.html">Scripting Ganga</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/ganga-scripting.html#defining-jobs-with-scripts">Defining jobs with scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/ganga-scripting.html#adding-helpers-functions">Adding helpers functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/managing-files-with-ganga.html">Managing files in Ganga</a></li>
<li class="toctree-l2"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html">Advanced Dirac</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#gangatasks">GangaTasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#alternative-backends-dirac-python-bugged">Alternative Backends - DIRAC (Python bugged)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#alternative-backends-dirac-davinci">Alternative Backends - DIRAC (DaVinci)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../second-analysis-steps/advanced-dirac.html#alternative-backends-condor">Alternative Backends - Condor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../self-guided-lessons/README.html">Self guided lessons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../self-guided-lessons/htcondor.html">Batch submission using HTCondor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor-first-job.html">Submitting a simple job</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-first-job.html#tracking-your-jobs">Tracking your jobs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html">More submit file options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#input-files">Input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#output-files">Output files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#arguments">Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#resources-and-requirements">Resources and Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-more-options.html#notifications">Notifications</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html">Using the queue command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html#more-on-variables">More on variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html#other-ways-to-queue">Other ways to queue</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/htcondor-queue.html#mixing-options-and-variables">Mixing options and variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor.html#system-architecture">System architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/htcondor.html#other-useful-resources">Other useful resources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html">Creating a grid proxy without LbScripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#installation">Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#macos-with-homebrew">macOS with homebrew</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#ubuntu">Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#centos">CentOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#arch-linux">Arch Linux</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#getting-the-required-files-and-certificates">Getting the required files and certificates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#creating-a-proxy">Creating a proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self-guided-lessons/local-grid-proxy.html#managing-the-proxy">Managing the proxy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../CONTRIBUTING.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CONTRIBUTING.html#dependencies">Dependencies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../CONDUCT.html">Contributor Code of Conduct</a></li>
<li class="toctree-l3"><a class="reference internal" href="../LICENSE.html">Instructional Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="../LICENSE.html#software">Software</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External links:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://hsf-training.github.io/analysis-essentials/">Analysis essentials</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cern.ch/lhcb-core-doc/">LHCb Core documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://lhcb.github.io/glossary/">LHCb glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">LHCb Starterkit Lessons</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="README.html">First Analysis Steps</a></li>
      <li class="breadcrumb-item active">Running a minimal DaVinci job locally</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/lhcb/starterkit-lessons/blob/master/first-analysis-steps/minimal-dv-job.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-a-minimal-davinci-job-locally">
<h1>Running a minimal DaVinci job locally<a class="headerlink" href="#running-a-minimal-davinci-job-locally" title="Permalink to this heading"></a></h1>
<p><a class="reference internal" href="interactive-dst.html"><span class="doc">Looping event-by-event</span></a> over a file and <a class="reference internal" href="loki-functors.html"><span class="doc">inspecting
interesting quantities with LoKi functors</span></a> is great for
exploration: to check that the file contains the candidates you need, that
the topology makes sense, and so on.
It’s impractical for most cases, though, where you want <em>all</em> the candidates
your trigger/stripping line produced, which could be tens of millions of
decays.
In these cases we use DaVinci, the application for analysing high-level
information such as tracks and vertices, which we’ll look at in this lesson to
produce a ROOT ntuple.</p>
<div class="panel panel-objectives docutils container">
<div class="panel-header open docutils container">
<p id="learning-objectives"><i class="fa fa-line-chart"></i> Learning Objectives</p>
</div>
<div class="panel-body docutils container">
<ul class="simple">
<li><p>Run a DaVinci job over a local DST</p></li>
<li><p>Inspect the ntuple output</p></li>
</ul>
</div>
</div>
<p>With some stripped data located, it’s useful to store the information on the
selected particles inside an ntuple.
A DST can only be read properly using the LHCb software stack and contains lots of
things we’re not interested in. An ntuple contains just the data we need, and
allows for quick, local analysis with <a class="reference external" href="https://root.cern.ch/">ROOT</a> or a
compatible reader library like
<a class="reference external" href="https://github.com/scikit-hep/uproot4">Uproot</a>.</p>
<p>As well as being the application that runs the stripping,
<a class="reference external" href="http://lhcbdoc.web.cern.ch/lhcbdoc/davinci/">DaVinci</a>
allows you to access events stored in DSTs and copy the information to ROOT
ntuples.
You tell DaVinci what you want it to do through <em>options files</em>, written in
Python.
There are lots of things you can do with DaVinci options files, as there’s lots
of information available on the DST, but for now we’ll just work on getting the
bare essentials up and running.</p>
<p>Our main tool will be the <code class="docutils literal notranslate"><span class="pre">DecayTreeTuple</span></code> object, which we’ll create inside a
file we will call <code class="docutils literal notranslate"><span class="pre">ntuple_options.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">DecayTreeTuple</span>
<span class="kn">from</span> <span class="nn">DecayTreeTuple.Configuration</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Stream and stripping line we want to use</span>
<span class="n">stream</span> <span class="o">=</span> <span class="s1">&#39;AllStreams&#39;</span>
<span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;D2hhPromptDst2D2KKLine&#39;</span>

<span class="c1"># Create an ntuple to capture D*+ decays from the StrippingLine line</span>
<span class="n">dtt</span> <span class="o">=</span> <span class="n">DecayTreeTuple</span><span class="p">(</span><span class="s1">&#39;TupleDstToD0pi_D0ToKK&#39;</span><span class="p">)</span>
<span class="n">dtt</span><span class="o">.</span><span class="n">Inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/Event/</span><span class="si">{0}</span><span class="s1">/Phys/</span><span class="si">{1}</span><span class="s1">/Particles&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">line</span><span class="p">)]</span>
<span class="n">dtt</span><span class="o">.</span><span class="n">Decay</span> <span class="o">=</span> <span class="s1">&#39;[D*(2010)+ -&gt; (D0 -&gt; K- K+) pi+]CC&#39;</span>
</pre></div>
</div>
<p>This imports the <code class="docutils literal notranslate"><span class="pre">DecayTreeTuple</span></code> class, and then creates an object called
<code class="docutils literal notranslate"><span class="pre">dtt</span></code> representing our ntuple-creating algorithm.
Once DaVinci has run, the resulting ntuple will be saved in a folder within the
output ROOT file called <code class="docutils literal notranslate"><span class="pre">TupleDstToD0pi_D0ToKpi</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> attribute specifies where <code class="docutils literal notranslate"><span class="pre">DecayTreeTuple</span></code> should look for
particles in the TES, and here we want it to look at the output of the stripping line
we’re interested in.</p>
<p>As stripping lines can save many decays to a DST, the <code class="docutils literal notranslate"><span class="pre">Decay</span></code> attribute
specifies what decay we would like to have in our ntuple.
If there are no particles at the <code class="docutils literal notranslate"><span class="pre">Input</span></code> location, or the <code class="docutils literal notranslate"><span class="pre">Decay</span></code> string
doesn’t match any particles at that location, the ntuple will not be filled.</p>
<div class="panel panel-callout docutils container">
<div class="panel-header open docutils container">
<p id="decay-descriptors"><i class="fa fa-info-circle"></i> Decay descriptors</p>
</div>
<div class="panel-body docutils container">
<p>There is a special syntax for the <code class="docutils literal notranslate"><span class="pre">Decay</span></code> attribute string, commonly called
‘decay descriptors’, that allow a lot of flexibility with what you accept.
For example, <code class="docutils literal notranslate"><span class="pre">D0</span> <span class="pre">-&gt;</span> <span class="pre">K-</span> <span class="pre">X+</span></code> will match any D0 decay that contains one
negatively charged kaon and one positively charged track of any species.
More information the decay descriptor syntax can be found on the <a class="reference external" href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/LoKiNewDecayFinders">LoKi decay
finders TWiki
page</a>.
The complete list of allowed particle names is defined in the detector description database (DDDB) which can be <a class="reference external" href="https://gitlab.cern.ch/lhcb-conddb/DDDB/-/blob/master/param/ParticleTable.txt">browsed on GitLab</a>.</p>
</div>
</div>
<p>Now we need to tell DaVinci how to behave.
The <code class="docutils literal notranslate"><span class="pre">DaVinci</span></code> class allows you to tell DaVinci how many events to run over,
what type of data is being used, what algorithms to run over the events, and so
on.</p>
<p>There are <a class="reference external" href="https://lhcb-doxygen.web.cern.ch/lhcb-doxygen/davinci/latest/py/dc/d2f/class_da_vinci_1_1_configuration_1_1_da_vinci.html">many configuration
attributes</a>
defined on the <code class="docutils literal notranslate"><span class="pre">DaVinci</span></code> object, but we will only set the ones that are
necessary for us.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Configurables</span> <span class="kn">import</span> <span class="n">DaVinci</span>

<span class="c1"># Configure DaVinci</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">UserAlgorithms</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dtt</span><span class="p">]</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">InputType</span> <span class="o">=</span> <span class="s1">&#39;DST&#39;</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">TupleFile</span> <span class="o">=</span> <span class="s1">&#39;DVntuple.root&#39;</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">PrintFreq</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">DataType</span> <span class="o">=</span> <span class="s1">&#39;2016&#39;</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">Simulation</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># Only ask for luminosity information when not using simulated data</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">Lumi</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">Simulation</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">EvtMax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">CondDBtag</span> <span class="o">=</span> <span class="s1">&#39;sim-20170721-2-vc-md100&#39;</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">DDDBtag</span> <span class="o">=</span> <span class="s1">&#39;dddb-20170721-3&#39;</span>
</pre></div>
</div>
<p>Nicely, a lot of the attributes of the <code class="docutils literal notranslate"><span class="pre">DaVinci</span></code> object are self-explanatory:
<code class="docutils literal notranslate"><span class="pre">InputType</span></code> should be <code class="docutils literal notranslate"><span class="pre">'DST'</span></code> when giving DaVinci DST files; <code class="docutils literal notranslate"><span class="pre">PrintFreq</span></code>
defines how often DaVinci should print its status; <code class="docutils literal notranslate"><span class="pre">DataType</span></code> is the year of
data-taking the data corresponds to, which we get from looking at the
bookkeeping path used to get the input DST; <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> should be <code class="docutils literal notranslate"><span class="pre">True</span></code> when
using Monte Carlo data; <code class="docutils literal notranslate"><span class="pre">Lumi</span></code> defines whether to store information on the
integrated luminosity the input data corresponds to; and <code class="docutils literal notranslate"><span class="pre">EvtMax</span></code> defines how
many events to run over, where a value of <code class="docutils literal notranslate"><span class="pre">-1</span></code> means “all events”.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CondDBtag</span></code> and <code class="docutils literal notranslate"><span class="pre">DDDBtag</span></code> attributes specify the exact detector conditions
that the Monte Carlo was generated with.
Specifying these tags is important, as without them you can end up with the
wrong magnet polarity value in your ntuple, amongst other Bad Things.
You can find the values for these tags in the <a class="reference download internal" download="" href="../_downloads/1f7f5ac7463dc79a8a4f9b4d819fdab8/MC_2016_27163002_Beam6500GeV2016MagDownNu1.625nsPythia8_Sim09c_Trig0x6138160F_Reco16_Turbo03_Stripping28r1NoPrescalingFlagged_ALLSTREAMS.DST.py"><code class="xref download docutils literal notranslate"><span class="pre">bookkeeping</span>
<span class="pre">file</span></code></a>
we downloaded earlier.</p>
<div class="panel panel-callout docutils container">
<div class="panel-header open docutils container">
<p id="database-tags"><i class="fa fa-info-circle"></i> Database tags</p>
</div>
<div class="panel-body docutils container">
<p>Generally, the <code class="docutils literal notranslate"><span class="pre">CondDB</span></code> and <code class="docutils literal notranslate"><span class="pre">DDDB</span></code> tags are different for each dataset you
want to use, but will be the same for all DSTs within a given dataset.</p>
<p>For real collision data, you shouldn’t specify these tags, as the default
tags are the latest and greatest, so just remove those lines from the options
file.</p>
<p>However, when using simulated data, <em>always</em> find out what the database tags are for
your dataset!</p>
<p>There are several ways to access the database tags used for a specific production, but the most reliable one consists of the following steps:</p>
<ul class="simple">
<li><p>Find the bookkeeping location of any DST for your desired event type and conditions (e.g. <code class="docutils literal notranslate"><span class="pre">/lhcb/MC/2016/ALLSTREAMS.DST/00070793/0000/00070793_00000002_7.AllStreams.dst</span></code>).</p></li>
<li><p>The number after <code class="docutils literal notranslate"><span class="pre">ALLSTREAMS.DST</span></code> is the number of the production: in this case, <code class="docutils literal notranslate"><span class="pre">00070793</span></code>.</p></li>
<li><p>Go to the <a class="reference external" href="https://lhcb-portal-dirac.cern.ch/DIRAC/?view=tabs&amp;theme=Grey&amp;url_state=1%7C*LHCbDIRAC.LHCbTransformationMonitor.classes.LHCbTransformationMonitor:,">transformation monitor</a>. Put this number in the field <code class="docutils literal notranslate"><span class="pre">ProductionID(s):</span></code> and press “Submit”. You will see the details of the production to the right.</p></li>
<li><p>Right click on these details, and press “Show request”. The new tab “Production Request manager” will appear to the right of the “LHCb Transformation Monitor”. Go to that tab.</p></li>
<li><p>You will see the details of the MC request. Right click on it, and press “View”.</p></li>
<li><p>A new window will pop up with the complete details of the request. You have to find the “Step 1” section, and the following line in it <code class="docutils literal notranslate"><span class="pre">DDDB:</span> <span class="pre">dddb-20170721-3</span> <span class="pre">Condition</span> <span class="pre">DB:</span> <span class="pre">sim-20170721-2-vc-md100</span></code> contains your database tags.</p></li>
</ul>
<p>Note that the Condition DB tags for different magnet polarities are different: <code class="docutils literal notranslate"><span class="pre">-md100</span></code> should be replaced by <code class="docutils literal notranslate"><span class="pre">-mu100</span></code> for the MagUp conditions.</p>
<p>This method can also be used to find other details about how any data was processed by DIRAC, such as the options files and application versions.</p>
</div>
</div>
<p>In order to run an algorithm that we have previously created, we need to add it
to the <code class="docutils literal notranslate"><span class="pre">UserAlgorithms</span></code> list.
The <code class="docutils literal notranslate"><span class="pre">TupleFile</span></code> attribute defines the name of the ROOT output file that DaVinci
will store any algorithm output in, which should be our ntuple.</p>
<div class="panel panel-callout docutils container">
<div class="panel-header open docutils container">
<p id="being-smart-and-efficient"><i class="fa fa-info-circle"></i> Being smart and efficient</p>
</div>
<div class="panel-body docutils container">
<p>Typical stripping lines take only a small part of the stripped stream - so, a small fraction of events in the DST: actually, usually you care about a single TES location!
At the same time, event unpacking and running the DecayTreeTuple machinery for each event is time-consuming.
Consequently, DSTs can be processed much faster if before unpacking we select <em>only</em> events which are likely to accomodate the desired TES location. This can be achieved, for example, by requiring a prefilter checking whether event passes a stripping requirement. You may also filter on trigger decisions - this is an idea behind the Turbo stream.
As a conclusion, it is <em>strongly</em> recommended to exploit the <code class="docutils literal notranslate"><span class="pre">EventPreFilters</span></code> method offered by <code class="docutils literal notranslate"><span class="pre">DaVinci</span></code>: this feature can save a lot of processing time and collaboration’s computing resources when running over millions of events.
To require events to pass a specific stripping line requirement, one should add these lines to the options file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PhysConf.Filters</span> <span class="kn">import</span> <span class="n">LoKi_Filters</span>
<span class="n">fltrs</span> <span class="o">=</span> <span class="n">LoKi_Filters</span> <span class="p">(</span>
    <span class="n">STRIP_Code</span> <span class="o">=</span> <span class="s2">&quot;HLT_PASS_RE(&#39;StrippingD2hhPromptDst2D2KKLineDecision&#39;)&quot;</span>
<span class="p">)</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">EventPreFilters</span> <span class="o">=</span> <span class="n">fltrs</span><span class="o">.</span><span class="n">filters</span><span class="p">(</span><span class="s1">&#39;Filters&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we use the <a class="reference external" href="https://lhcb-doxygen.web.cern.ch/lhcb-doxygen/davinci/latest/d7/dae/namespace_lo_ki_1_1_cuts.html#aee4bba9ae8443acd970dd52e20e5b8c1">LoKi functor <code class="docutils literal notranslate"><span class="pre">HLT_PASS_RE</span></code></a> which checks for a positive decision on (in this case) the stripping line.
You may investigate some of more advanced examples of <code class="docutils literal notranslate"><span class="pre">EventPreFilters</span></code> usage <a class="reference external" href="https://twiki.cern.ch/twiki/bin/view/LHCb/FAQ/DaVinciFAQ#How_to_process_the_stripped_DSTs">here</a> and <a class="reference external" href="https://gitlab.cern.ch/lhcb/Phys/-/blob/run2-patches/Phys/PhysConf/python/PhysConf/Filters.py">here</a>.</p>
</div>
</div>
<p>All that’s left to do is to say what data we would like to run over.
As we already have a data file <a class="reference internal" href="files-from-grid.html"><span class="doc">downloaded locally</span></a>, we
define that as our input data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">GaudiConf</span> <span class="kn">import</span> <span class="n">IOHelper</span>

<span class="c1"># Use the local input data</span>
<span class="n">IOHelper</span><span class="p">()</span><span class="o">.</span><span class="n">inputFiles</span><span class="p">([</span>
    <span class="s1">&#39;./00070793_00000001_7.AllStreams.dst&#39;</span>
<span class="p">],</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This says to use the <code class="docutils literal notranslate"><span class="pre">.dst</span></code> file that is in the same directory as the options
file, and to clear any previous input files that might have been defined.</p>
<p>That’s it! We’re ready to run DaVinci.</p>
<p>In the same folder as your options file <code class="docutils literal notranslate"><span class="pre">ntuple_options.py</span></code> and your DST file
ending in <code class="docutils literal notranslate"><span class="pre">.dst</span></code>, there’s just a single command you need run on <code class="docutils literal notranslate"><span class="pre">lxplus</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>lb-run<span class="w"> </span>DaVinci/v45r8<span class="w"> </span>gaudirun.py<span class="w"> </span>ntuple_options.py
</pre></div>
</div>
<p>The full options file we’ve created, <code class="docutils literal notranslate"><span class="pre">ntuple_options.py</span></code>, is <a class="reference download internal" download="" href="../_downloads/937445760fade9c86cf97523b587a29c/ntuple_options.py"><code class="xref download docutils literal notranslate"><span class="pre">available</span>
<span class="pre">here</span></code></a>.
A slightly modified version that uses remote files (using an XML catalog as
<a class="reference internal" href="files-from-grid.html"><span class="doc">described here</span></a>) is <a class="reference download internal" download="" href="../_downloads/6f0d9c7b57aaa6d301065f6ede4788a9/ntuple_options_xmlcatalog.py"><code class="xref download docutils literal notranslate"><span class="pre">available</span>
<span class="pre">here</span></code></a>.</p>
<p>You can now view and inspect your ntuple using ROOT <code class="docutils literal notranslate"><span class="pre">TBrowser</span></code> just do:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>root<span class="w"> </span>-l<span class="w"> </span>DVntuple.root<span class="w"> </span>

root<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span>
Attaching<span class="w"> </span>file<span class="w"> </span>DVntuple.root<span class="w"> </span>as<span class="w"> </span>_file0...
<span class="o">(</span>TFile<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x2ae94f0
root<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>new<span class="w"> </span>TBrowser
<span class="o">(</span>TBrowser<span class="w"> </span>*<span class="o">)</span><span class="w"> </span>0x2fe31b0
</pre></div>
</div>
<div class="panel panel-callout docutils container">
<div class="panel-header open docutils container">
<p id="using-a-microdst"><i class="fa fa-info-circle"></i> Using a microDST</p>
</div>
<div class="panel-body docutils container">
<p>A microDST (or µDST) is a smaller version of a DST.
Some stripping lines go to µDSTs, and some go to DSTs.
There are two things that need changing in our options file in order to have
it work when it is used with a stripping line that goes to a µDST:</p>
<ol class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">DecayTreeTuple.Inputs</span></code> attribute should start at the word
<code class="docutils literal notranslate"><span class="pre">Phys</span></code>; and</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">RootInTES</span></code> attribute on the <code class="docutils literal notranslate"><span class="pre">DaVinci</span></code> object has to be set to
<code class="docutils literal notranslate"><span class="pre">/Event/$STREAM</span></code></p></li>
</ol>
<p>In context, the changes look like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dtt</span><span class="o">.</span><span class="n">Inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Phys/</span><span class="si">{0}</span><span class="s1">/Particles&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)]</span>
<span class="c1"># ...</span>
<span class="n">DaVinci</span><span class="p">()</span><span class="o">.</span><span class="n">RootInTES</span> <span class="o">=</span> <span class="s1">&#39;/Event/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="interactive-dst.html" class="btn btn-neutral float-left" title="Interactively exploring a DST" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="loki-functors.html" class="btn btn-neutral float-right" title="Fun with LoKi Functors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2020, LHCb Starterkit.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>